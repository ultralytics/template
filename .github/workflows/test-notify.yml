# Ultralytics üöÄ AGPL-3.0 License - https://ultralytics.com/license

# Test Slack notification logic

name: Test Notify

on:
  push:
  workflow_dispatch:
    inputs:
      simulate_success:
        type: boolean
        description: Simulate success (true) or failure (false)
        default: true

jobs:
  mock_check:
    runs-on: ubuntu-latest
    outputs:
      increment: "True"
      current_tag: v1.0.0
      previous_tag: v0.9.9
      pypi_url: https://pypi.org/p/ultralytics-template
    steps:
      - run: echo "Mock check job"

  mock_publish:
    needs: mock_check
    runs-on: ubuntu-latest
    steps:
      - run: |
          if [ "${{ github.event.inputs.simulate_success }}" = "true" ]; then
            echo "Simulating success"
            exit 0
          else
            echo "Simulating failure"
            exit 1
          fi

  notify:
    needs: [mock_check, mock_publish]
    if: always() && needs.mock_check.outputs.increment == 'True'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Notify Slack
        uses: slackapi/slack-github-action@v2.1.1
        env:
          TITLE: ${{ needs.mock_publish.result == 'success' && format('<!channel> <https://github.com/{0}/actions/runs/{1}|GitHub Actions> {2} {3} for {4} ‚úÖ\nNEW `{0} {5}` <{6}|package> published üòÉ', github.repository, github.run_id, github.event_name, job.status, github.workflow, needs.mock_check.outputs.current_tag, needs.mock_check.outputs.pypi_url) || format('<!channel> <https://github.com/{0}/actions/runs/{1}|GitHub Actions> {2} {3} for {4} ‚ùå', github.repository, github.run_id, github.event_name, job.status, github.workflow) }}
        with:
          webhook-type: incoming-webhook
          webhook: ${{ secrets.SLACK_WEBHOOK_URL_LLM }}
          payload: |
            text: "${{ env.TITLE }}\n\n\n*Repository:* https://github.com/${{ github.repository }}\n*Author:* ${{ github.actor }}\n*<https://github.com/${{ github.repository }}/commit/${{ github.sha }}|Commit>:* ${{ github.event.head_commit.message }}\n"
